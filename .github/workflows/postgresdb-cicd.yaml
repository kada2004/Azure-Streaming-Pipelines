name: PostgreSQL SQL CI/CD

on:
  pull_request:
    paths:
    - 'postgres/sql/**'
  push:
    branches:
    - main
    paths:
    - 'postgres/sql/**'

permissions:
  contents: read

jobs:
  validate:
    name: Validate PostgreSQL SQL (Timescale-safe)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client

    - name: Validate SQL scripts
      env:
        PGHOST: azpostgresflexible.postgres.database.azure.com
        PGPORT: 5432
        PGDATABASE: postgres
        PGUSER: psqladmin
        PGPASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        PGSSLMODE: require
      run: |
        set -euo pipefail

        echo " Phase 1: Syntax validation of base tables (rollback)"
        for file in postgres/sql/Tables/*.sql; do
          if ! grep -qi "create_hypertable" "$file"; then
            echo "=== Validating (rollback) $file ==="
            psql \
              --set ON_ERROR_STOP=on \
              --single-transaction \
              --file="$file" \
              --command="ROLLBACK;"
          fi
        done

        echo " Phase 2: Apply base tables so FKs exist"
        for file in postgres/sql/Tables/*.sql; do
          if ! grep -qi "create_hypertable" "$file"; then
            echo "=== Applying $file ==="
            psql \
              --set ON_ERROR_STOP=on \
              --file="$file"
          fi
        done

        echo " Phase 3: Validate Timescale hypertables"
        for file in postgres/sql/Tables/*.sql; do
          if grep -qi "create_hypertable" "$file"; then
            echo "=== Validating $file ==="
            psql \
              --set ON_ERROR_STOP=on \
              --file="$file"
          fi
        done

  deploy:
    name: Deploy SQL to PostgreSQL
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client

    - name: Deploy SQL scripts
      env:
        PGHOST: azpostgresflexible.postgres.database.azure.com
        PGPORT: 5432
        PGDATABASE: postgres
        PGUSER: psqladmin
        PGPASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        PGSSLMODE: require
      run: |
        set -euo pipefail

        for file in postgres/sql/Tables/*.sql; do
          echo "=== Deploying $file ==="
          psql \
            --set ON_ERROR_STOP=on \
            --file="$file"
        done
