name: PostgreSQL SQL CI/CD

on:
  pull_request:
    paths:
    - 'postgres/sql/**'
  push:
    branches:
    - main
    paths:
    - 'postgres/sql/**'

permissions:
  contents: read

jobs:
  validate:
    name: Validate PostgreSQL SQL
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client

    - name: Validate SQL scripts (single transaction rollback)
      env:
        PGHOST: azpostgresflexible.postgres.database.azure.com
        PGPORT: 5432
        PGDATABASE: postgres
        PGUSER: psqladmin
        PGPASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        PGSSLMODE: require
      run: |
        set -euo pipefail

        echo "=== Validating all SQL files in ONE transaction ==="

        # Concatenate all SQL files EXCEPT TimescaleDB extension bootstrap
        cat $(find postgres/sql/Tables -name "*.sql" \
          ! -name "00_enable_timescaledb.sql" | sort) | \
        psql \
          --set ON_ERROR_STOP=on \
          --single-transaction

        echo "=== Validation completed (rolled back automatically) ==="

  deploy:
    name: Deploy SQL to PostgreSQL
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client

    - name: Deploy SQL scripts
      env:
        PGHOST: azpostgresflexible.postgres.database.azure.com
        PGPORT: 5432
        PGDATABASE: postgres
        PGUSER: psqladmin
        PGPASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        PGSSLMODE: require
      run: |
        set -euo pipefail

        echo "=== Deploying SQL files ==="

        for file in $(find postgres/sql/Tables -name "*.sql" | sort); do
          echo "=== Deploying $file ==="
          psql \
            --set ON_ERROR_STOP=on \
            --file="$file"
        done
